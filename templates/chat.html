{% extends "base.html" %}
{% load static %}

{% block content %}
<div id="chat-container">
  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div id="top-bar">
    <button id="menuButton">‚ò∞</button>
    <h3>–ß–∞—Ç Free Fire</h3>
    <button id="shopButton">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
  <div id="messages">
    {% for msg in messages %}
      <div class="message {% if msg.user == request.user %}user{% else %}other{% endif %}">
        {{ msg.user.username }}: {{ msg.message|safe }}
      </div>
    {% endfor %}
  </div>

  <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
  <div id="input-container">
    <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    <button id="emojiButton">üòä</button>
    <button id="sendButton">‚û§</button>
  </div>
</div>

<!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
<div id="sideMenu">
  <h3>–ú–µ–Ω—é</h3>
  <ul>
    <li id="settingsBtn">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</li>
    <li id="emojiMenuBtn">üòä –°–º–∞–π–ª—ã</li>
    <li id="commandsBtn">‚å® –ö–æ–º–∞–Ω–¥—ã</li>
  </ul>

  <div id="settingsPanel" class="panel">
    <h4>–§–æ–Ω —á–∞—Ç–∞</h4>
    <input type="color" id="bgColorPicker" value="#222222">
  </div>

  <div id="emojiPanel" class="panel">
    <h4>–í—ã–±–µ—Ä–∏ —Å–º–∞–π–ª</h4>
    <div class="emoji-grid">
      <span class="emoji">üòÄ</span>
      <span class="emoji">üòÇ</span>
      <span class="emoji">üòç</span>
      <span class="emoji">üòé</span>
      <span class="emoji">üò¢</span>
      <span class="emoji">üëç</span>
      <span class="emoji">üî•</span>
    </div>
  </div>

  <div id="commandsPanel" class="panel">
    <h4>–ö–æ–º–∞–Ω–¥—ã</h4>
    <ul>
      <li>/clear - –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</li>
      <li>/nick [–∏–º—è] - –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫</li>
    </ul>
  </div>
</div>

<div id="overlay"></div>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#1c1c1c; color:#fff; }
#chat-container { display:flex; flex-direction:column; height:100vh; max-width:500px; margin:auto; background:#2a2a2a; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.4); }
#top-bar { display:flex; align-items:center; justify-content:space-between; padding:12px; background:#3a3a3a; font-size:18px; font-weight:bold; }
#top-bar button { background:none; border:none; color:#fff; font-size:24px; cursor:pointer; transition:transform 0.2s; margin-left:8px; }
#top-bar button:hover { transform:scale(1.2); }
#messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; background:#222; transition: background 0.3s; }
.message { padding:10px 14px; border-radius:12px; max-width:70%; word-wrap:break-word; font-size:14px; line-height:1.4; opacity:0; transform:translateY(10px); animation:fadeIn 0.3s ease forwards; }
.message.user { background:#ff4747; align-self:flex-end; border-bottom-right-radius:2px; }
.message.other { background:#444; align-self:flex-start; border-bottom-left-radius:2px; }
@keyframes fadeIn { to { opacity:1; transform:translateY(0); } }
#input-container { display:flex; padding:10px; background:#2f2f2f; }
#messageInput { flex:1; padding:10px; border:none; border-radius:8px; outline:none; font-size:14px; background:#3a3a3a; color:#fff; }
#sendButton, #emojiButton { margin-left:5px; padding:10px 14px; border:none; border-radius:8px; background:#ff4747; color:#fff; font-size:16px; cursor:pointer; transition:background 0.3s; }
#sendButton:hover, #emojiButton:hover { background:#e53e3e; }

#sideMenu { position:fixed; top:0; left:-260px; width:240px; height:100%; background:#2b2b2b; color:#fff; padding:20px; transition:left 0.3s ease; z-index:1001; box-shadow:2px 0 10px rgba(0,0,0,0.5); }
#sideMenu h3 { margin-top:0; border-bottom:1px solid #444; padding-bottom:10px; }
#sideMenu ul { list-style:none; padding:0; }
#sideMenu li { margin:15px 0; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s; }
#sideMenu li:hover { background:#3a3a3a; }
#sideMenu.show { left:0; }

.panel { display:none; margin-top:15px; }
.panel.active { display:block; }

#overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; z-index:1000; }
#overlay.show { display:block; }

.emoji-grid { display:flex; flex-wrap:wrap; gap:5px; }
.emoji { cursor:pointer; font-size:20px; }
</style>

<script>
const menuButton = document.getElementById('menuButton');
const sideMenu = document.getElementById('sideMenu');
const overlay = document.getElementById('overlay');
const sendButton = document.getElementById('sendButton');
const emojiButton = document.getElementById('emojiButton');
const messageInput = document.getElementById('messageInput');
const messages = document.getElementById('messages');
const shopButton = document.getElementById('shopButton');

const settingsBtn = document.getElementById('settingsBtn');
const emojiMenuBtn = document.getElementById('emojiMenuBtn');
const commandsBtn = document.getElementById('commandsBtn');

const settingsPanel = document.getElementById('settingsPanel');
const emojiPanel = document.getElementById('emojiPanel');
const commandsPanel = document.getElementById('commandsPanel');
const bgColorPicker = document.getElementById('bgColorPicker');

menuButton.addEventListener('click', () => { sideMenu.classList.toggle('show'); overlay.classList.toggle('show'); });
overlay.addEventListener('click', () => { sideMenu.classList.remove('show'); overlay.classList.remove('show'); settingsPanel.classList.remove('active'); emojiPanel.classList.remove('active'); commandsPanel.classList.remove('active'); });
shopButton.addEventListener('click', () => { window.location.href = '/products/'; });

// –ü–æ–∫–∞–∑ –ø–∞–Ω–µ–ª–µ–π
settingsBtn.addEventListener('click', () => { togglePanel(settingsPanel); });
emojiMenuBtn.addEventListener('click', () => { togglePanel(emojiPanel); });
commandsBtn.addEventListener('click', () => { togglePanel(commandsPanel); });

function togglePanel(panel) {
  [settingsPanel, emojiPanel, commandsPanel].forEach(p => p !== panel ? p.classList.remove('active') : null);
  panel.classList.toggle('active');
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ —á–∞—Ç–∞
bgColorPicker.addEventListener('input', () => { messages.style.background = bgColorPicker.value; });

// –í—Å—Ç–∞–≤–∫–∞ —Å–º–∞–π–ª–æ–≤
document.querySelectorAll('.emoji').forEach(e => {
  e.addEventListener('click', () => { messageInput.value += e.textContent; messageInput.focus(); });
});

// WebSocket
const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
const chatSocket = new WebSocket(ws_scheme + '://' + window.location.host + '/ws/chat/');

chatSocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  const div = document.createElement("div");
  div.innerHTML = data.username + ": " + data.message;
  div.classList.add("message", data.username === "{{ request.user.username }}" ? "user" : "other");
  messages.appendChild(div);
  messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
};

chatSocket.onclose = function(e) { console.error('Chat socket closed unexpectedly'); };

function sendMessage() {
  const message = messageInput.value.trim();
  if (message.length === 0) return;

  // –ö–æ–º–∞–Ω–¥—ã
  if (message.startsWith("/")) {
    if (message.startsWith("/clear")) { messages.innerHTML = ""; messageInput.value=""; return; }
    if (message.startsWith("/nick")) {
      let parts = message.split(" ");
      if (parts[1]) alert("–ù–∏–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ " + parts[1]); // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–º–µ–Ω—É –Ω–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      messageInput.value=""; return;
    }
  }

  chatSocket.send(JSON.stringify({ "message": message }));
  messageInput.value = '';
}

  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', e => { if(e.key==="Enter") sendMessage(); });
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}–ß–∞—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞{% endblock %}

{% block content %}
<div class="chat-container">
    <h1>üí¨ –ß–∞—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</h1>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="chat-box"></div>

    <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
    <form id="chat-form">
        <input id="message-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>

<style>
/* --- CSS --- */
.chat-container {
    max-width: 800px;
    margin: auto;
    padding: 20px;
    font-family: Arial, sans-serif;
}

#chat-box {
    border: 1px solid #ccc;
    height: 400px;
    overflow-y: auto;
    padding: 10px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 15px;
}

#chat-form {
    display: flex;
    gap: 10px;
}

#message-input {
    flex: 1;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    outline: none;
}

#chat-form button {
    padding: 10px 18px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
}

#chat-form button:hover {
    background: #0056b3;
}

.message.self {
    background: #e7f1ff;
    padding: 6px 10px;
    border-radius: 6px;
    max-width: 75%;
    margin-left: auto;
    text-align: right;
    margin-bottom: 8px;
}

.message.other {
    background: #f8f8f8;
    padding: 6px 10px;
    border-radius: 6px;
    max-width: 75%;
    margin-right: auto;
    margin-bottom: 8px;
}
</style>

<script>
/* --- JS --- */
const chatBox = document.getElementById("chat-box");
const chatForm = document.getElementById("chat-form");
const messageInput = document.getElementById("message-input");

// –ò–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Django
const username = "{{ request.user.username|escapejs }}";

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
const chatSocket = new WebSocket(
    (window.location.protocol === "https:" ? "wss://" : "ws://") +
    window.location.host +
    "/ws/chat/"
);

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const msgElement = document.createElement("div");

    if (data.username === username) {
        msgElement.classList.add("message", "self");
        msgElement.innerHTML = `<b>–í—ã:</b> ${data.message}`;
    } else {
        msgElement.classList.add("message", "other");
        msgElement.innerHTML = `<b>${data.username}:</b> ${data.message}`;
    }

    chatBox.appendChild(msgElement);
    chatBox.scrollTop = chatBox.scrollHeight; // –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
chatForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (message) {
        chatSocket.send(JSON.stringify({ message, username }));
        messageInput.value = "";
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ WebSocket –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener("beforeunload", () => {
    chatSocket.close();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
chatSocket.onerror = function(e) {
    console.error("WebSocket –æ—à–∏–±–∫–∞:", e);
};
</script>
{% endblock %}

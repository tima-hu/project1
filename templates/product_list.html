{% extends "base.html" %}
{% load static %}
{% block title %}–ö–∞—Ç–∞–ª–æ–≥{% endblock %}

{% block extra_head %}
<style>
  .product-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
  }
  .card {
    width: 220px;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: 0.2s ease-in-out;
  }
  .card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  .card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 8px;
  }
  .button {
    background: #007bff;
    color: #fff;
    padding: 8px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    width: 100%;
    font-size: 14px;
    transition: background 0.2s;
  }
  .button:hover {
    background: #0056b3;
  }
  #search-input {
    width: 100%;
    padding: 10px;
    margin-bottom: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  #search-results {
    border: 1px solid #eee;
    background: #fff;
    display: none;
    margin-bottom: 12px;
    max-height: 250px;
    overflow-y: auto;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #search-results div {
    padding: 8px;
    border-bottom: 1px solid #eee;
  }
  #search-results a {
    text-decoration: none;
    color: #007bff;
  }
  #search-results div:hover {
    background-color: #f9f9f9;
  }
</style>
{% endblock %}

{% block content %}
<h1>–ö–∞—Ç–∞–ª–æ–≥</h1>

<!-- –ü–æ–∏—Å–∫ -->
<input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫..." value="{{ query }}">
<div id="search-results"></div>

<!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="product-grid" id="product-list">
  {% for product in page_obj.object_list %}
    <div class="card" data-product-id="{{ product.id }}">
      <a href="{% url 'product_detail' product.pk %}">
        <img src="{% if product.image %}{{ product.image.url }}{% else %}https://via.placeholder.com/220x140?text=No+image{% endif %}" alt="{{ product.name }}">
      </a>
      <h3 style="font-size:16px;margin:6px 0;">{{ product.name }}</h3>
      <div style="color:#28a745;font-weight:bold">{{ product.price }} —Å–æ–º</div>
      <form class="add-to-cart-form" data-id="{{ product.id }}">
        {% csrf_token %}
        <input type="hidden" name="quantity" value="1">
        <button type="submit" class="button">–í –∫–æ—Ä–∑–∏–Ω—É</button>
      </form>
    </div>
  {% empty %}
    <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ üòî</p>
  {% endfor %}
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div style="margin-top:20px;text-align:center;">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">‚Üê –ù–∞–∑–∞–¥</a>
  {% endif %}
  <span style="margin:0 10px">
    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
  </span>
  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}">–í–ø–µ—Ä—ë–¥ ‚Üí</a>
  {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É —á–µ—Ä–µ–∑ AJAX
document.querySelectorAll('.add-to-cart-form').forEach(form => {
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const productId = this.dataset.id;
    const formData = new FormData(this);

    fetch("{% url 'cart_add_ajax' 0 %}".replace('/0/', '/' + productId + '/'), {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        const cartCount = document.getElementById('cart-count');
        if (cartCount) cartCount.textContent = Object.keys(data.cart).length;
        alert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
      }
    })
    .catch(err => {
      console.error(err);
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    });
  });
});

// –ñ–∏–≤–æ–π –ø–æ–∏—Å–∫
const searchInput = document.getElementById('search-input');
const resultsBox = document.getElementById('search-results');
let timer = null;

searchInput.addEventListener('input', function() {
  clearTimeout(timer);
  const q = this.value.trim();

  if (!q) {
    resultsBox.style.display = 'none';
    resultsBox.innerHTML = '';
    return;
  }

  timer = setTimeout(() => {
    fetch("{% url 'live_search' %}?q=" + encodeURIComponent(q))
      .then(r => r.json())
      .then(data => {
        if (data.results.length === 0) {
          resultsBox.innerHTML = '<div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        } else {
          resultsBox.innerHTML = data.results.map(i =>
            `<div>
              <a href="{% url 'product_detail' 0 %}".replace('0', i.id)>
                ${i.name} ‚Äî ${i.price} —Å–æ–º
              </a>
            </div>`
          ).join('');
        }
        resultsBox.style.display = 'block';
      });
  }, 250);
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<h1>{{ product.title }}</h1>
<img src="{% if product.image %}{{ product.image.url }}{% else %}https://via.placeholder.com/400x300?text=No+image{% endif %}" style="max-width:400px;display:block;margin-bottom:12px;">
<p>{{ product.description|linebreaks }}</p>
<p style="font-weight:bold">{{ product.price }} сом</p>

<form id="detail-add" data-id="{{ product.id }}">
  {% csrf_token %}
  <label>Количество: <input type="number" name="quantity" value="1" min="1" style="width:60px"></label>
  <button type="submit" class="button">Добавить в корзину</button>
</form>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

document.getElementById('detail-add').addEventListener('submit', function(e) {
  e.preventDefault();
  const productId = this.dataset.id;
  const formData = new FormData(this);
  fetch("{% url 'cart_add_ajax' 0 %}".replace('/0/', '/' + productId + '/'), {
    method: 'POST',
    headers: {'X-CSRFToken': getCookie('csrftoken')},
    body: formData
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      const cartCount = document.getElementById('cart-count');
      if (cartCount) cartCount.textContent = data.cart_count;
      showToast('Добавлено в корзину');  // Заменили alert на showToast
    } else {
      showToast('Ошибка');
    }
  });
});
</script>
{% endblock %}
